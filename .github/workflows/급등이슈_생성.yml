name: 급등이슈 카드 자동 생성

on:
  workflow_dispatch:  # 수동 실행만 가능

jobs:
  generate-image:
    runs-on: ubuntu-22.04
    
    steps:
    - name: 체크아웃
      uses: actions/checkout@v3
    
    - name: Python 설정
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'
    
    - name: Python 패키지 캐시
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Playwright 캐시
      uses: actions/cache@v3
      with:
        path: ~/.cache/ms-playwright
        key: ${{ runner.os }}-playwright-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-playwright-
    
    - name: 패키지 설치
      run: |
        pip install -r requirements.txt
        python -m playwright install chromium
    
    - name: Playwright 시스템 의존성 설치
      run: |
        sudo apt-get update
        sudo apt-get install -y libnss3 libnspr4 libatk1.0-0 libatk-bridge2.0-0 libcups2 libdrm2 libxkbcommon0 libxcomposite1 libxdamage1 libxfixes3 libxrandr2 libgbm1 libasound2
    
    - name: 서비스 계정 키 생성
      env:
        GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
      run: |
        echo "$GOOGLE_CREDENTIALS" > service_account.json.json
    
    - name: 급등이슈 이미지 생성
      run: python main.py
    
    - name: 생성된 이미지 업로드
      uses: actions/upload-artifact@v4
      with:
        name: stock-issue-images
        path: output/급등이슈_*.png
        retention-days: 30
    
    - name: 이미지를 레포지토리에 커밋 (선택사항)
      if: success()
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add output/급등이슈_*.png || true
        git commit -m "자동 생성: 급등이슈 $(date +'%Y.%m.%d')" || true
        git push || true

